<!DOCTYPE html>
<html lang="en">
   <head>
      <!-- Basic -->
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="viewport" content="initial-scale=1, maximum-scale=1">
      <!-- Site metas -->
      <title>AGPLANT VISION</title>
      <meta name="keywords" content="">
      <meta name="description" content="">
      <meta name="author" content="">
      <!-- Bootstrap css -->
      <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
      <!-- Style css -->
      <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
      <!-- Responsive-->
      <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
      <!-- Favicon -->
      <link rel="icon" href="{{ url_for('static', filename='images/fevicon.png') }}" type="image/gif" />
      <!-- Scrollbar Custom CSS -->
      <link rel="stylesheet" href="{{ url_for('static', filename='css/jquery.mCustomScrollbar.min.css') }}">
      <!-- Tweaks for older IEs-->
      <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
      <!-- Owl stylesheets --> 
      <link rel="stylesheet" href="{{ url_for('static', filename='css/owl.carousel.min.css') }}">
      <style>
         .table-container{
            max-height: 300px;
            min-height: 300px;
            overflow: auto;
            font-size: 14px;
            background-color: #F5F5DC;
            padding: 10px;
            color: green;
         }

         .table-container::-webkit-scrollbar {
            width: 8px;
         }

         .table-container::-webkit-scrollbar-track {
            background: #e0e0e0;
         }

         .table-container::-webkit-scrollbar-thumb {
            background-color: green;
            border-radius: 10px;
         }

         /* Set column widths */
         .table-container th:nth-child(1), .table-container td:nth-child(1) {
            width: 35%;
         }

         .table-container th:nth-child(2), .table-container td:nth-child(2) {
            width: 20%; 
         }

         .table-container th:nth-child(3), .table-container td:nth-child(3) {
            width: 20%; 
         }

         .table-container th:nth-child(4), .table-container td:nth-child(4) {
            width: 20%; 
         }

         #downloadBtn {
            display: none;
            margin-top: 10px;
            align-self: center;
         }

         .button-container {
            display: flex;
            justify-content: center;
            width: 100%;
         }

         #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex; 
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.8);
            z-index: 999;
         }

         #loadingOverlay img {
            width: 150px; 
            height: 150px; 
         }

         .upload-area {
            border: 2px dashed #ccc;
            border-radius: 5px;
            width: 300px;
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 0 auto;
         }

         .upload-icon {
            text-align: center;
         }

         .upload-icon img {
            width: 50px;
            height: 50px;
         }

         .upload-input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
         }

         .center-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
         }

         .center-content label {
            text-align: center;
         }

         @media (max-width: 480px) {
            .table-container::-webkit-scrollbar {
                width: 8px;
            }

            .table-container::-webkit-scrollbar-track {
                background: #e0e0e0;
            }

            .table-container::-webkit-scrollbar-thumb {
                background-color: green;
                border-radius: 10px;
            }
        }
      </style>
   </head>
   <body>
        <!-- Header section start -->
         <div class="header_section">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
               <div class="logo d-flex justify-content-center align-items-center">
                  <a href="{{ url_for('homepage') }}"><img src="{{ url_for('static', filename='images/logo-2.png') }}" width="80" height="80"></a>
                  <a href="{{ url_for('homepage') }}" class="logo-text text-justify text-white">
                     A G P L A N T <br> V I S I O N
                  </a>
               </div>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                  <div class="navbar-nav">
                     <a class="nav-item nav-link" href="{{ url_for('homepage') }}">Home</a>
                     <a class="nav-item nav-link" href="{{ url_for('detection_page') }}">Detection</a>
                     <a class="nav-item nav-link" href="{{ url_for('realtime_webcam') }}">Realtime Webcam</a>
                  </div>
                </div>
            </nav>
            <!-- Banner section end -->
        
            <div class="banner_section mt-2">
               <div class="container">
                  <div class="row justify-content-center">
                     <div class="col-lg-12 col-md-12 col-sm-12">
                        <div class="tabs">
                           <input type="radio" id="tab1" name="tab-control" checked>
                           <input type="radio" id="tab2" name="tab-control">
                           <input type="radio" id="tab3" name="tab-control">
                           <ul>
                              <li title="Upload Image"><label for="tab1" role="button"><span>Upload Image</span></label></li>
                              <li title="Video Stream"><label for="tab2" role="button"><span>Video Stream</span></label></li>
                           </ul>
                           <div class="content">
                              <section>
                                 <div class="upload-area mt-5 mb-5" id="upload-area">
                                    <div class="upload-icon">
                                       <img src="{{ url_for('static', filename='images/upload.png') }}" alt="Upload Icon">
                                       <p>Supported file formats: JPG, PNG, JPEG</p>
                                    </div>
                                    <input type="file" id="file-input" class="upload-input" accept=".jpg,.jpeg,.png,.gif" onchange="uploadImage()">
                                 </div>
                                 <div class="card-content" id="card-content" style="display: none;">
                                    <div id="loadingOverlay" style="display: none;">
                                       <img src="{{ url_for('static', filename='images/loader.gif') }}" alt="Loading...">
                                    </div>
                                 </div>
                              </section>
                              <section>
                                 <div id="video-url-form" class="mt-5">
                                    <div class="center-content">
                                       <label for="url" class="h5 form-label mb-4">Video/Live Stream URL:</label>
                                    </div>
                                    <div class="pb-5">
                                       <form id="urlForm">
                                          <div class="mb-5 mx-2">
                                             <input type="text" class="form-control form-control-lg" style="font-size: 16px;" id="url" name="url" placeholder="Enter Your URL Here" required>
                                          </div>
                                          <div class="col-md-12 text-center">
                                             <button class="btn btn-dark col-md-4 text-white" id="start" type="button" onclick="startVideo()">Start Stream</button>
                                          </div>
                                       </form>
                                    </div>
                                 </div>
                              </section>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Banner section end -->
         </div>
         <!-- Header section end -->
           
         <!-- Footer section start --> 
         <div class="footer_section layout_padding">
            <div class="container">
               <div class="row">
                  <div class="col-lg-3 col-sm-6">
                     <h2 class="useful_text">About</h2>
                     <p class="ipsum_text">We are <strong style="color: #a3b104;">AGPLANT VISION</strong> ready for dedicated to transforming agriculture through advanced plant species detection technology.</p>
                  </div>
                  <div class="col-lg-3 col-sm-6">
                     <h2 class="useful_text">Services</h2>
                     <div class="footer_links">
                        <ul>
                           <li class="active"><a href="#">Image Detection</a></li>
                           <li class="active"><a href="#">Video Detection</a></li>
                           <li class="active"><a href="#">Real Time Detection</a></li>
                           <li class="active"><a href="#">Image Segmentation</a></li>
                           <li class="active"><a href="#">Video Segmentation</a></li>
                           <li class="active"><a href="#">Real Time Segmentation</a></li>
                        </ul>
                     </div>
                  </div>
                  <div class="col-lg-3 col-sm-6">
                     <h2 class="useful_text">Species</h2>
                     <div class="footer_links">
                        <ul>
                           <li class="active"><a href="#">Black Grass</a></li>
                           <li class="active"><a href="#">Himalayan Balsam</a></li>
                           <li class="active"><a href="#">Ground Elder</a></li>
                           <li class="active"><a href="#">Giant Hogweed</a></li>
                           <li class="active"><a href="#">Japanese Knotweed</a></li>
                           <li class="active"><a href="#">Bindweed</a></li>
                        </ul>
                     </div>
                  </div>
                  <div class="col-lg-3 col-sm-6">
                     <h2 class="useful_text">contact us</h2>
                     <div class="addres_link">
                        <ul>
                           <li><a href="#"><img src="{{ url_for('static', filename='images/map-icon.png') }}"><span class="padding_left_10">Worldwide</span></a></li>
                           <li><a href="#"><img src="{{ url_for('static', filename='images/call-icon.png') }}"><span class="padding_left_10">+01 1234567890</span></a></li>
                           <li><a href="#"><img src="{{ url_for('static', filename='images/mail-icon.png') }}"><span class="padding_left_10">demo@gmail.com</span></a></li>
                        </ul>
                     </div>
                  </div>
               </div>
            </div>
         </div>
         <!-- Footer section end -->  

         <!-- Copyright section start -->
         <div class="copyright_section">
            <div class="container">
               <p class="copyright_text">Copyright 2024 All Right Reserved By.<a href="https://html.design"> AGPLANT VISION</p>
            </div>
         </div>
         <!-- Copyright section end -->    
         <!-- Javascript files-->
         <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
         <script src="{{ url_for('static', filename='js/popper.min.js') }}"></script>
         <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
         <script src="{{ url_for('static', filename='js/jquery-3.0.0.min.js') }}"></script>
         <script src="{{ url_for('static', filename='js/plugin.js') }}"></script>
         <script src="{{ url_for('static', filename='js/jquery.mCustomScrollbar.concat.min.js') }}"></script>
         <script src="{{ url_for('static', filename='js/custom.js') }}"></script>
         <!-- javascript --> 
         <script>
            function inittab(tabWrapper, activeTab = 1) {
               const tabBtns = tabWrapper.querySelectorAll(".tab-btn");
               const underline = tabWrapper.querySelector(".underline");
               const tabContents = tabWrapper.querySelectorAll(".tab-content");

               activeTab = activeTab - 1;
               tabBtns[activeTab].classList.add("active");
               underline.style.width = `${tabBtns[activeTab].offsetWidth}px`;
               underline.style.left = `${tabBtns[activeTab].offsetLeft}px`;
               tabContents.forEach((content) => {
                  content.style.transform = `translateX(-${activeTab * 100}%)`;
               });

               tabBtns.forEach((btn, index) => {
                  btn.addEventListener("click", () => {
                     tabBtns.forEach((btn) => btn.classList.remove("active"));
                     btn.classList.add("active");
                     underline.style.width = `${btn.offsetWidth}px`;
                     underline.style.left = `${btn.offsetLeft}px`;
                     tabContents.forEach((content) => {
                     content.style.transform = `translateX(-${index * 100}%)`;
                     });
                  });

                  btn.addEventListener("focus", () => {
                     tabBtns.forEach((btn) => btn.classList.remove("active"));
                     btn.classList.add("active");
                     underline.style.width = `${btn.offsetWidth}px`;
                     underline.style.left = `${btn.offsetLeft}px`;
                     tabContents.forEach((content) => {
                     content.style.transform = `translateX(-${index * 100}%)`;
                     });
                  });
               });
            }

            const tabWrappers = document.querySelectorAll(".tab-wrapper");
            tabWrappers.forEach((tabWrapper, index) => inittab(tabWrapper));

            function uploadImage() {
               const fileInput = document.getElementById('file-input');
               const file = fileInput ? fileInput.files[0] : null;

               if (!file) {
                  alert("Please select a file to upload.");
                  return;
               }

               const formData = new FormData();
               formData.append('file', file);

               const cardContent = document.getElementById('card-content');
               const loadingOverlay = document.getElementById('loadingOverlay');
               const uploadArea = document.getElementById('upload-area');

               if (loadingOverlay) {
                  loadingOverlay.style.display = 'flex';
               }

               if (cardContent) {
                  cardContent.style.display = 'flex';
               }

               if (uploadArea) {
                  uploadArea.style.display = 'none';
               }

               fetch('/upload', {
                  method: 'POST',
                  body: formData
               })
               .then(response => {
                  if (!response.ok) {
                     throw new Error(`Server error: ${response.status} ${response.statusText}`);
                  }
                  return response.json();
               })
               .then(data => {
                  if (data.error) {
                     throw new Error(data.error);
                  }

                  const classes = {
                     'Japanese Knotweed': 0,
                     'Himalayan Balsam': 0,
                     'Bindweed': 0,
                     'Ground Elder': 0,
                     'Giant Hogweed': 0,
                     'Black Grass': 0
                  };

                  if (data.detections) {
                     for (const [key, value] of Object.entries(data.detections)) {
                        if (classes.hasOwnProperty(key)) {
                           classes[key] = value;
                        }
                     }
                  }

                  let detectionsHtml = '';

                  for (const [key, value] of Object.entries(classes)) {
                     detectionsHtml += `<p class="list-text">${key} : ${value}</p>`;
                  }

                  let detectionDetailsHtml = `
                        <table class="table table-container table-borderless table-responsive card-1 p-4">
                           <thead>
                              <tr>
                                    <th>Class</th>
                                    <th style="width:50%">Confidence</th>
                                    <th style="width:50%">Width (inches)</th>
                                    <th style="width:50%">Height (inches)</th>
                              </tr>
                           </thead>
                           <tbody>`;

                  if (data.detection_details) {
                        data.detection_details.forEach(detection => {
                           detectionDetailsHtml += `
                              <tr>
                                    <td>${detection.class}</td>
                                    <td>${detection.confidence}</td>
                                    <td>${detection.width}</td>
                                    <td>${detection.height}</td>
                              </tr>`;
                        });
                  }

                  detectionDetailsHtml += '</tbody></table>';

                  if (cardContent) {
                        cardContent.innerHTML = `
                           <div class="container">
                              <div class="row mt-3" id="detection-results">
                                 <div class="col-lg-12 col-md-12 col-sm-12 mb-4 img-container">
                                    <img src="data:image/jpeg;base64,${data.image_base64}" alt="Detected Image" class="img-fluid"> 
                                 </div>
                                 <div class="col-lg-6 col-md-12 col-sm-12">
                                    <h6 class="card-title">Object Tracking Count</h6>
                                    ${detectionsHtml}
                                 </div>
                                 <div class="col-lg-6 col-md-12 col-sm-12">
                                    <h6 class="card-title">Table Result</h6>
                                    ${detectionDetailsHtml}
                                 </div>
                                 <div class="col-md-12 btn-container mt-5 mb-5">
                                    <button class="btn btn-dark col-md-4 text-white" id="back" type="button" onclick="location.reload()">Back</button>
                                    <button class="btn btn-success col-md-4 text-white" id="download" type="button" onclick="downloadCSV()">Download</button>
                                 </div>
                              </div>
                           </div>`;
                  }

                  if (loadingOverlay) {
                     loadingOverlay.style.display = 'none';
                  }
               })
               .catch(error => {
                  alert(`Upload failed: ${error.message}`);
                  if (loadingOverlay) {
                     loadingOverlay.style.display = 'none';
                  }
               });
            }

            function downloadCSV() {
               const table = document.querySelector('#detection-results table');
               if (!table) {
                  alert('No table found to export.');
                  return;
               }

               const rows = Array.from(table.querySelectorAll('tr'));

               const csvContent = rows.map(row => {
                  const cells = Array.from(row.querySelectorAll('th, td')).map(cell => cell.textContent);
                  return cells.join(',');
               }).join('\n');

               const blob = new Blob([csvContent], { type: 'text/csv' });
               const url = URL.createObjectURL(blob);

               const a = document.createElement('a');
               a.href = url;
               a.download = 'results.csv';
               a.click();

               URL.revokeObjectURL(url);
            }

            function startVideo() {
               const url = document.getElementById('url').value;
               const urlForm = document.getElementById('urlForm');
               
               if (urlForm && url) {
                  urlForm.setAttribute('action', '/detection-video');
                  urlForm.setAttribute('method', 'POST');
                  urlForm.submit();
               } else {
                  alert('Please enter a valid URL.');
               }
            }
         </script>
   </body>
</html>
